<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Join Tournament - MENI</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: #1f1f1f;
      font-family: 'Space Grotesk', sans-serif;
      color: #f5f5f5;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff9900, #ffbb55);
  color: #1f1f1f;
  padding: 0.9rem 1.5rem;
  border-radius: 16px;
  font-size: 0.95rem;
  font-family: 'Space Grotesk', sans-serif;
  box-shadow: 0 8px 20px rgba(255, 153, 0, 0.3);
  opacity: 0;
  pointer-events: none;
  z-index: 999;
}
.toast {
  opacity: 0;
  pointer-events: none;
  transform: translateX(-50%) translateY(-20px) scale(0.95);
}
.toast.show {
  animation: toastFadeIn 0.4s ease forwards;
  pointer-events: auto;
}

@keyframes toastFadeIn {
  0% {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px) scale(0.95);
  }
  100% {
    opacity: 1;
    transform: translateX(-50%) translateY(0) scale(1);
  }
}

@keyframes toastFadeOut {
  0% {
    opacity: 1;
    transform: translateX(-50%) translateY(0) scale(1);
  }
  100% {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px) scale(0.95);
  }
}
    h2 {
      color: #ff9900;
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
      text-align: center;
		padding-top: calc(env(safe-area-inset-top) + 45px);
    }
    .upload-area {
      width: 100%;
      max-width: 350px;
      min-height: 300px;
      background-color: #2b2b2b;
      border: 2px dashed #ff9900;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 0.9rem;
      flex-direction: column;
      cursor: pointer;
      margin-bottom: 1.5rem;
      transition: border-color 0.3s, background-color 0.3s;
      overflow: hidden;
      position: relative;
    }
    .upload-area:hover { border-color: #ffa733; }
    .upload-area input { display: none; }
    .upload-area .plus { font-size: 2rem; color: #ff9900; margin-bottom: 0.5rem; }
    .preview-img { width: 100%; height: auto; display: none; }
    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: #ff9900;
      color: #1f1f1f;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1.2rem;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .remove-btn:hover { background-color: #ffa733; }
    .form-group {
      width: 100%;
      max-width: 350px;
      margin-bottom: 1.5rem;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      width: 100%;
      max-width: 350px;
    }
    .button-group button {
      flex: 1;
      padding: 0.6rem;
      border-radius: 10px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .back-btn { background-color: #2b2b2b; color: #f5f5f5; border: 2px solid #444; }
    .back-btn:hover { background-color: #3a3a3a; }
    .upload-btn { background-color: #ff9900; color: #1f1f1f; }
    .upload-btn:hover { background-color: #ffa733; }
  </style>
</head>
<body>

  <div class="toast" id="toast"></div>

  <h2>Upload Your Meme</h2>

  <label class="upload-area" id="uploadArea">
    <button id="removeBtn" class="remove-btn">&times;</button>
    <div class="plus" id="uploadText">+</div>
    <span id="uploadSubtext">Tap to upload your meme</span>
    <img id="previewImage" class="preview-img" />
    <input type="file" id="fileInput" accept="image/*" />
  </label>

  <div class="button-group">
    <button class="back-btn" onclick="goBack()">Back</button>
    <button id="uploadBtn" class="upload-btn" onclick="uploadMeme()">Upload</button>
  </div>

  <script>
   const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');
const previewImage = document.getElementById('previewImage');
const uploadText = document.getElementById('uploadText');
const uploadSubtext = document.getElementById('uploadSubtext');
const removeBtn = document.getElementById('removeBtn');
const uploadBtn = document.getElementById('uploadBtn');
const toast = document.getElementById('toast');

let alreadyUploaded = false;

function showToast(msg) {
  if (!msg) return;
  toast.textContent = msg;
  toast.classList.remove('hide');
  toast.classList.add('show');

  // بعد از 2.5 ثانیه شروع به خروج کن
  setTimeout(() => {
    toast.classList.remove('show');
    toast.style.animation = 'toastFadeOut 0.4s ease forwards';
    
    // بعد از انیمیشن خروج، ریست کنیم
    setTimeout(() => {
      toast.style.animation = '';
    }, 400);
  }, 2500);
}

function hideToast() {
  toast.classList.remove('show');
  toast.style.animation = 'toastFadeOut 0.4s ease forwards';
  setTimeout(() => {
    toast.style.animation = '';
  }, 400);
}

// ابتدا چک کنیم که آیا کاربر قبلا میم آپلود کرده یا نه
function checkIfUploaded() {
  const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
  if (!tgUser) {
    console.error('Telegram user data not found.');
    return;
  }

  fetch(`https://meni-server.onrender.com/check-upload/${tgUser.id}`)
    .then(res => res.json())
    .then(data => {
      if (data.uploaded) {
        alreadyUploaded = true;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = "Already Uploaded";
        uploadBtn.style.backgroundColor = "#444";
        uploadBtn.style.color = "#aaa";
        uploadArea.style.backgroundColor = "#3a3a3a";
        uploadArea.style.cursor = "default";
        uploadArea.style.pointerEvents = "none";
        uploadArea.style.opacity = 0.6;
      } else {
        // اگر هنوز آپلود نکرده اجازه بده
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = "Upload";
        uploadArea.style.pointerEvents = "auto";
        uploadArea.style.opacity = 1;
      }
    })
    .catch(err => {
      console.error("Check upload error:", err);
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = "Upload";
      uploadArea.style.pointerEvents = "auto";
      uploadArea.style.opacity = 1;
    });
}

uploadArea.addEventListener('click', () => {
  if (!uploadBtn.disabled) {
    fileInput.click();
  } else {
    showToast("You have already uploaded your meme");
  }
});

fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImage.src = e.target.result;
      previewImage.style.display = 'block';
      uploadText.style.display = 'none';
      uploadSubtext.style.display = 'none';
      removeBtn.style.display = 'flex';

      const img = new Image();
      img.onload = function() {
        uploadArea.style.height = this.height * (uploadArea.offsetWidth / this.width) + 'px';
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

removeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  fileInput.value = '';
  previewImage.style.display = 'none';
  uploadText.style.display = 'block';
  uploadSubtext.style.display = 'block';
  removeBtn.style.display = 'none';
  uploadArea.style.height = '300px';
});

function uploadMeme() {
  if (alreadyUploaded) {
    showToast("You have already uploaded your meme.");
    return;
  }

  if (!fileInput.files.length) {
    showToast('Please select your meme first.');
    return;
  }


  const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
  if (!tgUser) {
    showToast('Telegram data not found.');
    return;
  }

  const telegramUsername = tgUser.username || "unknown";
  const telegramId = tgUser.id; // آیدی عددی
  const uploadTime = new Date().toISOString();

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'meni_upload');

  // درست کردن context
  const contextData = `telegramUsername=${telegramUsername}|telegramId=${telegramId}|likes=0|votes=0|uploadTime=${uploadTime}|voters=[]`;
  formData.append('context', contextData);

  showToast('Uploading your meme...');
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = "Uploading...";

  fetch('https://api.cloudinary.com/v1_1/doosolmoo/image/upload', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (!data.secure_url) {
      throw new Error("Upload failed");
    }

    return fetch('https://meni-server.onrender.com/upload', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        memeUrl: data.secure_url,
        telegramUsername: telegramUsername,
        telegramId: telegramId,
        likes: 0,
        votes: 0,
        uploadTime: uploadTime
      })
    });
  })
  .then(res => res.json())
  .then(serverData => {
    if (!serverData.success) {
      throw new Error(serverData.message || 'Server error');
    }

    showToast('Your meme was successfully uploaded!');
    uploadBtn.innerHTML = "Uploaded";
    uploadBtn.style.backgroundColor = "#444";
    uploadBtn.style.color = "#aaa";
    uploadArea.style.backgroundColor = "#3a3a3a";
    uploadArea.style.cursor = "default";
    removeBtn.style.display = "none";
    alreadyUploaded = true;
  })
  .catch(err => {
    console.error("Upload Error:", err);
    showToast('Error: ' + (err.message || 'Unknown error'));
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = "Upload";
  });
}

// اجرای چک اولیه وقتی صفحه لود شد
document.addEventListener('DOMContentLoaded', () => {
  // قفل اولیه هنگام لود
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = "Checking...";
  uploadArea.style.pointerEvents = "none";
  uploadArea.style.opacity = 0.6;

  checkIfUploaded();
});

  </script>
</body>
</html>